Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 3376F282EE6
	for <lists+linux-kernel@lfdr.de>; Mon,  5 Oct 2020 04:40:58 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1725903AbgJECky (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Sun, 4 Oct 2020 22:40:54 -0400
Received: from mailgw01.mediatek.com ([210.61.82.183]:58491 "EHLO
        mailgw01.mediatek.com" rhost-flags-OK-FAIL-OK-FAIL) by vger.kernel.org
        with ESMTP id S1725845AbgJECky (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 4 Oct 2020 22:40:54 -0400
X-UUID: 1ac8d4c9d4a4466c9d72dde7ac8ccaf5-20201005
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=mediatek.com; s=dk;
        h=Content-Transfer-Encoding:Content-Type:MIME-Version:References:In-Reply-To:Message-ID:Date:Subject:CC:To:From; bh=EUI7uOkc6wflbcN4dLdDFLe1TAyO6/KD9JziaxsXixA=;
        b=YD4ULh4jHW2Np/msBKmiLJBTH2iiTAfYPXFdSQ8FQloyGk6XrupFx1KDuLTr1AGwkQZvJSPMTNEnSscLIhAspzCMXYqb8RuuegRlHeHAI70i2pEpdeVxJ/1+XtW7vm6tlame/a3iBrbRz7P/kltJxZwlXw3L9iK1yaYnj09k2Ko=;
X-UUID: 1ac8d4c9d4a4466c9d72dde7ac8ccaf5-20201005
Received: from mtkcas08.mediatek.inc [(172.21.101.126)] by mailgw01.mediatek.com
        (envelope-from <chinwen.chang@mediatek.com>)
        (Cellopoint E-mail Firewall v4.1.14 Build 0819 with TLSv1.2 ECDHE-RSA-AES256-SHA384 256/256)
        with ESMTP id 46171417; Mon, 05 Oct 2020 10:40:50 +0800
Received: from MTKCAS06.mediatek.inc (172.21.101.30) by
 mtkmbs02n1.mediatek.inc (172.21.101.77) with Microsoft SMTP Server (TLS) id
 15.0.1497.2; Mon, 5 Oct 2020 10:40:44 +0800
Received: from mtkswgap22.mediatek.inc (172.21.77.33) by MTKCAS06.mediatek.inc
 (172.21.101.73) with Microsoft SMTP Server id 15.0.1497.2 via Frontend
 Transport; Mon, 5 Oct 2020 10:40:44 +0800
From:   Chinwen Chang <chinwen.chang@mediatek.com>
To:     Andrew Morton <akpm@linux-foundation.org>
CC:     <linux-mm@kvack.org>, <linux-kernel@vger.kernel.org>,
        Chinwen Chang <chinwen.chang@mediatek.com>,
        Michel Lespinasse <walken@google.com>
Subject: [RESEND, PATCH v4 3/3] mm: proc: smaps_rollup: do not stall write attempts on mmap_lock
Date:   Mon, 5 Oct 2020 10:40:14 +0800
Message-ID: <1601865614-4918-4-git-send-email-chinwen.chang@mediatek.com>
X-Mailer: git-send-email 1.9.1
In-Reply-To: <1601865614-4918-1-git-send-email-chinwen.chang@mediatek.com>
References: <1601865614-4918-1-git-send-email-chinwen.chang@mediatek.com>
MIME-Version: 1.0
Content-Type: text/plain
X-MTK:  N
Content-Transfer-Encoding: base64
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

c21hcHNfcm9sbHVwIHdpbGwgdHJ5IHRvIGdyYWIgbW1hcF9sb2NrIGFuZCBnbyB0aHJvdWdoIHRo
ZSB3aG9sZSB2bWENCmxpc3QgdW50aWwgaXQgZmluaXNoZXMgdGhlIGl0ZXJhdGluZy4gV2hlbiBl
bmNvdW50ZXJpbmcgbGFyZ2UgcHJvY2Vzc2VzLA0KdGhlIG1tYXBfbG9jayB3aWxsIGJlIGhlbGQg
Zm9yIGEgbG9uZ2VyIHRpbWUsIHdoaWNoIG1heSBibG9jayBvdGhlcg0Kd3JpdGUgcmVxdWVzdHMg
bGlrZSBtbWFwIGFuZCBtdW5tYXAgZnJvbSBwcm9ncmVzc2luZyBzbW9vdGhseS4NCg0KVGhlcmUg
YXJlIHVwY29taW5nIG1tYXBfbG9jayBvcHRpbWl6YXRpb25zIGxpa2UgcmFuZ2UtYmFzZWQgbG9j
a3MsIGJ1dA0KdGhlIGxvY2sgYXBwbGllZCB0byBzbWFwc19yb2xsdXAgd291bGQgYmUgdGhlIGNv
YXJzZSB0eXBlLCB3aGljaCBkb2Vzbid0DQphdm9pZCB0aGUgb2NjdXJyZW5jZSBvZiB1bnBsZWFz
YW50IGNvbnRlbnRpb24uDQoNClRvIHNvbHZlIGFmb3JlbWVudGlvbmVkIGlzc3VlLCB3ZSBhZGQg
YSBjaGVjayB3aGljaCBkZXRlY3RzIHdoZXRoZXINCmFueW9uZSB3YW50cyB0byBncmFiIG1tYXBf
bG9jayBmb3Igd3JpdGUgYXR0ZW1wdHMuDQoNCkNoYW5nZSBzaW5jZSB2MToNCi0gSWYgY3VycmVu
dCBWTUEgaXMgZnJlZWQgYWZ0ZXIgZHJvcHBpbmcgdGhlIGxvY2ssIGl0IHdpbGwgcmV0dXJuDQot
IGluY29tcGxldGUgcmVzdWx0LiBUbyBmaXggdGhpcyBpc3N1ZSwgcmVmaW5lIHRoZSBjb2RlIGZs
b3cgYXMNCi0gc3VnZ2VzdGVkIGJ5IFN0ZXZlLiBbMV0NCg0KQ2hhbmdlIHNpbmNlIHYyOg0KLSBX
aGVuIGdldHRpbmcgYmFjayB0aGUgbW1hcCBsb2NrLCB0aGUgYWRkcmVzcyB3aGVyZSB5b3Ugc3Rv
cHBlZCBsYXN0DQotIHRpbWUgY291bGQgbm93IGJlIGluIHRoZSBtaWRkbGUgb2YgYSB2bWEuIEFk
ZCBvbmUgbW9yZSBjaGVjayB0byBoYW5kbGUNCi0gdGhpcyBjYXNlIGFzIHN1Z2dlc3RlZCBieSBN
aWNoZWwuIFsyXQ0KDQpDaGFuZ2Ugc2luY2UgdjM6DQotIGxhc3Rfc3RvcHBlZCBpcyBlYXNpbHkg
Y29uZnVzZWQgd2l0aCBsYXN0X3ZtYV9lbmQuIFJlcGxhY2UgaXQgd2l0aA0KLSBhIGRpcmVjdCBj
YWxsIHRvIHNtYXBfZ2F0aGVyX3N0YXRzKHZtYSwgJm1zcywgbGFzdF92bWFfZW5kKSBhcw0KLSBz
dWdnZXN0ZWQgYnkgU3RldmUuIFszXQ0KDQpbMV0gaHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvbGtt
bC9iZjQwNjc2ZS1iMTRiLTQ0Y2QtNzVjZS00MTljNzAxOTQ3ODNAYXJtLmNvbS8NClsyXSBodHRw
czovL2xvcmUua2VybmVsLm9yZy9sa21sL0NBTk42ODlGdENzQzcxY2pBanMwR1BzcE9oZ29fSFJq
K2RpV3NvVTF3cjk4WVBrdGdXZ0BtYWlsLmdtYWlsLmNvbS8NClszXSBodHRwczovL2xvcmUua2Vy
bmVsLm9yZy9sa21sL2RiMGQ0MGUyLTcyZjMtMDlkNS1jMTYyLTljNDkyMThmMTI4ZkBhcm0uY29t
Lw0KDQpDaGFuZ2UtSWQ6IElkY2RiNjQ3OGNjZDA2YTllNWVkZDRlZGE5Mjg1Mzc4ZTk2MWE2Yjk0
DQpTaWduZWQtb2ZmLWJ5OiBDaGlud2VuIENoYW5nIDxjaGlud2VuLmNoYW5nQG1lZGlhdGVrLmNv
bT4NClJldmlld2VkLWJ5OiBTdGV2ZW4gUHJpY2UgPHN0ZXZlbi5wcmljZUBhcm0uY29tPg0KQ0M6
IE1pY2hlbCBMZXNwaW5hc3NlIDx3YWxrZW5AZ29vZ2xlLmNvbT4NCi0tLQ0KIGZzL3Byb2MvdGFz
a19tbXUuYyB8IDY2ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrLQ0KIDEgZmlsZSBjaGFuZ2VkLCA2NSBpbnNlcnRpb25zKCspLCAxIGRlbGV0aW9u
KC0pDQoNCmRpZmYgLS1naXQgYS9mcy9wcm9jL3Rhc2tfbW11LmMgYi9mcy9wcm9jL3Rhc2tfbW11
LmMNCmluZGV4IDc2ZTYyM2EuLjFhODA2MjQgMTAwNjQ0DQotLS0gYS9mcy9wcm9jL3Rhc2tfbW11
LmMNCisrKyBiL2ZzL3Byb2MvdGFza19tbXUuYw0KQEAgLTg2Nyw5ICs4NjcsNzMgQEAgc3RhdGlj
IGludCBzaG93X3NtYXBzX3JvbGx1cChzdHJ1Y3Qgc2VxX2ZpbGUgKm0sIHZvaWQgKnYpDQogDQog
CWhvbGRfdGFza19tZW1wb2xpY3kocHJpdik7DQogDQotCWZvciAodm1hID0gcHJpdi0+bW0tPm1t
YXA7IHZtYTsgdm1hID0gdm1hLT52bV9uZXh0KSB7DQorCWZvciAodm1hID0gcHJpdi0+bW0tPm1t
YXA7IHZtYTspIHsNCiAJCXNtYXBfZ2F0aGVyX3N0YXRzKHZtYSwgJm1zcywgMCk7DQogCQlsYXN0
X3ZtYV9lbmQgPSB2bWEtPnZtX2VuZDsNCisNCisJCS8qDQorCQkgKiBSZWxlYXNlIG1tYXBfbG9j
ayB0ZW1wb3JhcmlseSBpZiBzb21lb25lIHdhbnRzIHRvDQorCQkgKiBhY2Nlc3MgaXQgZm9yIHdy
aXRlIHJlcXVlc3QuDQorCQkgKi8NCisJCWlmIChtbWFwX2xvY2tfaXNfY29udGVuZGVkKG1tKSkg
ew0KKwkJCW1tYXBfcmVhZF91bmxvY2sobW0pOw0KKwkJCXJldCA9IG1tYXBfcmVhZF9sb2NrX2tp
bGxhYmxlKG1tKTsNCisJCQlpZiAocmV0KSB7DQorCQkJCXJlbGVhc2VfdGFza19tZW1wb2xpY3ko
cHJpdik7DQorCQkJCWdvdG8gb3V0X3B1dF9tbTsNCisJCQl9DQorDQorCQkJLyoNCisJCQkgKiBB
ZnRlciBkcm9wcGluZyB0aGUgbG9jaywgdGhlcmUgYXJlIGZvdXIgY2FzZXMgdG8NCisJCQkgKiBj
b25zaWRlci4gU2VlIHRoZSBmb2xsb3dpbmcgZXhhbXBsZSBmb3IgZXhwbGFuYXRpb24uDQorCQkJ
ICoNCisJCQkgKiAgICstLS0tLS0rLS0tLS0tKy0tLS0tLS0tLS0tKw0KKwkJCSAqICAgfCBWTUEx
IHwgVk1BMiB8IFZNQTMgICAgICB8DQorCQkJICogICArLS0tLS0tKy0tLS0tLSstLS0tLS0tLS0t
LSsNCisJCQkgKiAgIHwgICAgICB8ICAgICAgfCAgICAgICAgICAgfA0KKwkJCSAqICA0ayAgICAg
OGsgICAgIDE2ayAgICAgICAgIDQwMGsNCisJCQkgKg0KKwkJCSAqIFN1cHBvc2Ugd2UgZHJvcCB0
aGUgbG9jayBhZnRlciByZWFkaW5nIFZNQTIgZHVlIHRvDQorCQkJICogY29udGVudGlvbiwgdGhl
biB3ZSBnZXQ6DQorCQkJICoNCisJCQkgKglsYXN0X3ZtYV9lbmQgPSAxNmsNCisJCQkgKg0KKwkJ
CSAqIDEpIFZNQTIgaXMgZnJlZWQsIGJ1dCBWTUEzIGV4aXN0czoNCisJCQkgKg0KKwkJCSAqICAg
IGZpbmRfdm1hKG1tLCAxNmsgLSAxKSB3aWxsIHJldHVybiBWTUEzLg0KKwkJCSAqICAgIEluIHRo
aXMgY2FzZSwganVzdCBjb250aW51ZSBmcm9tIFZNQTMuDQorCQkJICoNCisJCQkgKiAyKSBWTUEy
IHN0aWxsIGV4aXN0czoNCisJCQkgKg0KKwkJCSAqICAgIGZpbmRfdm1hKG1tLCAxNmsgLSAxKSB3
aWxsIHJldHVybiBWTUEyLg0KKwkJCSAqICAgIEl0ZXJhdGUgdGhlIGxvb3AgbGlrZSB0aGUgb3Jp
Z2luYWwgb25lLg0KKwkJCSAqDQorCQkJICogMykgTm8gbW9yZSBWTUFzIGNhbiBiZSBmb3VuZDoN
CisJCQkgKg0KKwkJCSAqICAgIGZpbmRfdm1hKG1tLCAxNmsgLSAxKSB3aWxsIHJldHVybiBOVUxM
Lg0KKwkJCSAqICAgIE5vIG1vcmUgdGhpbmdzIHRvIGRvLCBqdXN0IGJyZWFrLg0KKwkJCSAqDQor
CQkJICogNCkgKGxhc3Rfdm1hX2VuZCAtIDEpIGlzIHRoZSBtaWRkbGUgb2YgYSB2bWEgKFZNQScp
Og0KKwkJCSAqDQorCQkJICogICAgZmluZF92bWEobW0sIDE2ayAtIDEpIHdpbGwgcmV0dXJuIFZN
QScgd2hvc2UgcmFuZ2UNCisJCQkgKiAgICBjb250YWlucyBsYXN0X3ZtYV9lbmQuDQorCQkJICog
ICAgSXRlcmF0ZSBWTUEnIGZyb20gbGFzdF92bWFfZW5kLg0KKwkJCSAqLw0KKwkJCXZtYSA9IGZp
bmRfdm1hKG1tLCBsYXN0X3ZtYV9lbmQgLSAxKTsNCisJCQkvKiBDYXNlIDMgYWJvdmUgKi8NCisJ
CQlpZiAoIXZtYSkNCisJCQkJYnJlYWs7DQorDQorCQkJLyogQ2FzZSAxIGFib3ZlICovDQorCQkJ
aWYgKHZtYS0+dm1fc3RhcnQgPj0gbGFzdF92bWFfZW5kKQ0KKwkJCQljb250aW51ZTsNCisNCisJ
CQkvKiBDYXNlIDQgYWJvdmUgKi8NCisJCQlpZiAodm1hLT52bV9lbmQgPiBsYXN0X3ZtYV9lbmQp
DQorCQkJCXNtYXBfZ2F0aGVyX3N0YXRzKHZtYSwgJm1zcywgbGFzdF92bWFfZW5kKTsNCisJCX0N
CisJCS8qIENhc2UgMiBhYm92ZSAqLw0KKwkJdm1hID0gdm1hLT52bV9uZXh0Ow0KIAl9DQogDQog
CXNob3dfdm1hX2hlYWRlcl9wcmVmaXgobSwgcHJpdi0+bW0tPm1tYXAtPnZtX3N0YXJ0LA0KLS0g
DQoxLjkuMQ0K

