Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id F346D284B91
	for <lists+linux-kernel@lfdr.de>; Tue,  6 Oct 2020 14:24:45 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726330AbgJFMYo (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Tue, 6 Oct 2020 08:24:44 -0400
Received: from mx2.suse.de ([195.135.220.15]:42050 "EHLO mx2.suse.de"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1726133AbgJFMYn (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Tue, 6 Oct 2020 08:24:43 -0400
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.221.27])
        by mx2.suse.de (Postfix) with ESMTP id DEB49B03B;
        Tue,  6 Oct 2020 12:24:41 +0000 (UTC)
Date:   Tue, 06 Oct 2020 14:24:41 +0200
Message-ID: <s5hmu0z5ypi.wl-tiwai@suse.de>
From:   Takashi Iwai <tiwai@suse.de>
To:     Jian-Hong Pan <jhp@endlessos.org>
Cc:     Takashi Iwai <tiwai@suse.com>, Kailang Yang <kailang@realtek.com>,
        alsa-devel@alsa-project.org, linux-kernel@vger.kernel.org,
        linux@endlessm.com
Subject: Re: [PATCH] ALSA: hda/realtek: Enable audio jacks of ASUS D700SA with ALC887
In-Reply-To: <20201006075334.92933-1-jhp@endlessos.org>
References: <20201006075334.92933-1-jhp@endlessos.org>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Tue, 06 Oct 2020 09:53:35 +0200,
Jian-Hong Pan wrote:
> 
> The ASUS D700SA desktop's audio (1043:2390) with ALC887 cannot detect
> the headset microphone and another headphone jack until
> ALC887_FIXUP_ASUS_HMIC and ALC887_FIXUP_ASUS_AUDIO quirks are applied.
> The NID 0x15 maps as the headset microphone and NID 0x19 maps as another
> headphone jack. Also need the function like alc887_fixup_asus_jack to
> enable the audio jacks.
> 
> Signed-off-by: Jian-Hong Pan <jhp@endlessos.org>
> Signed-off-by: Kailang Yang <kailang@realtek.com>
> ---
>  sound/pci/hda/patch_realtek.c | 41 +++++++++++++++++++++++++++++++++++
>  1 file changed, 41 insertions(+)
> 
> diff --git a/sound/pci/hda/patch_realtek.c b/sound/pci/hda/patch_realtek.c
> index d4f17b465892..8d0928bdc9ff 100644
> --- a/sound/pci/hda/patch_realtek.c
> +++ b/sound/pci/hda/patch_realtek.c
> @@ -1929,6 +1929,8 @@ enum {
>  	ALC1220_FIXUP_CLEVO_P950,
>  	ALC1220_FIXUP_CLEVO_PB51ED,
>  	ALC1220_FIXUP_CLEVO_PB51ED_PINS,
> +	ALC887_FIXUP_ASUS_AUDIO,
> +	ALC887_FIXUP_ASUS_HMIC,
>  };
>  
>  static void alc889_fixup_coef(struct hda_codec *codec,
> @@ -2141,6 +2143,30 @@ static void alc1220_fixup_clevo_pb51ed(struct hda_codec *codec,
>  	alc_fixup_headset_mode_no_hp_mic(codec, fix, action);
>  }
>  
> +static void alc887_asus_hp_automute_hook(struct hda_codec *codec,
> +					 struct hda_jack_callback *jack)
> +{
> +	struct alc_spec *spec = codec->spec;
> +	int vref;
> +
> +	snd_hda_gen_hp_automute(codec, jack);
> +
> +	vref = spec->gen.hp_jack_present ? 0xc4 : 0xc0;

Use the AC_PINCTL_* instead of the raw numbers.  Some values are
shortened form in hda_local.h, too (e.g. 0xc0 = PIN_HP).


> +	snd_hda_codec_write(codec, 0x19, 0, AC_VERB_SET_PIN_WIDGET_CONTROL,
> +			    vref);

Better to use snd_hda_set_pin_ctl().

> +}
> +
> +static void alc887_fixup_asus_jack(struct hda_codec *codec,
> +				     const struct hda_fixup *fix, int action)
> +{
> +	struct alc_spec *spec = codec->spec;
> +	if (action != HDA_FIXUP_ACT_PROBE)
> +		return;
> +	snd_hda_codec_write(codec, 0x1b, 0, AC_VERB_SET_PIN_WIDGET_CONTROL,
> +			    0xc0);

This one would be snd_hda_set_pin_ctl_cached(), so that it'll be
restored at resume.


thanks,

Takashi
